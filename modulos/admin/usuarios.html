<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Usuários - SmileCare</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex">
<!-- Sidebar -->
<aside class="w-64 bg-white shadow-md">
    <!-- Conteúdo do menu lateral -->
</aside>

<!-- Conteúdo principal -->
<main class="flex-1 p-6">
    <h2 class="text-2xl font-bold text-gray-800">Gestão de Usuários</h2>

    <div class="bg-white shadow rounded-xl p-6 mt-6">
        <h3 class="text-lg font-bold mb-4">Criar Novo Usuário</h3>
        <form id="createUserForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label for="nome" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                <input type="text" id="nome" name="nome" required
                       class="mt-1 w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 p-2">
            </div>
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700">E-mail</label>
                <input type="email" id="email" name="email" required
                       class="mt-1 w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 p-2">
            </div>
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700">Senha</label>
                <input type="password" id="password" name="password" required
                       class="mt-1 w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 p-2">
            </div>
            <div>
                <label for="role" class="block text-sm font-medium text-gray-700">Função</label>
                <select id="role" name="role" required
                        class="mt-1 w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 p-2">
                    <option value="Recepcionista">Recepcionista</option>
                    <option value="Dentista">Dentista</option>
                    <option value="Admin">Administrador</option>
                </select>
            </div>
            <div class="md:col-span-2 flex justify-end">
                <button type="submit"
                        class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    Criar Usuário
                </button>
            </div>
        </form>
    </div>
</main>
<script type="module">
    // Importa as funções necessárias do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // Importa 'db' (já inicializado) e 'firebaseConfig' do caminho correto.
    import { db, firebaseConfig } from '../../firebase-config.js';

    const createUserForm = document.getElementById('createUserForm');

    createUserForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const nome = createUserForm.nome.value;
        const email = createUserForm.email.value;
        const password = createUserForm.password.value;
        const role = createUserForm.role.value;

        // **CORREÇÃO: Para evitar que o admin seja deslogado,
        // criamos uma instância temporária do Firebase só para essa operação.**
        const tempAppName = 'user-creation-app-' + Date.now();
        const tempApp = initializeApp(firebaseConfig, tempAppName);
        const tempAuth = getAuth(tempApp);

        try {
            // ETAPA 1: Cria o login do novo usuário na instância temporária
            const userCredential = await createUserWithEmailAndPassword(tempAuth, email, password);
            const newUser = userCredential.user;

            // ETAPA 2: Salva os detalhes do novo usuário no Firestore,
            // usando a permissão do admin que continua logado na sessão principal e o 'db' principal.
            await setDoc(doc(db, "users", newUser.uid), {
                uid: newUser.uid,
                nome: nome,
                email: email,
                role: role
            });

            alert(`Usuário "${nome}" foi criado com sucesso!`);
            createUserForm.reset();

        } catch (error) {
            console.error("Erro ao criar usuário:", error);

            if (error.code === 'auth/email-already-in-use') {
                alert('Erro: Este e-mail já está cadastrado.');
            } else if (error.code === 'auth/weak-password') {
                alert('Erro: A senha deve ter no mínimo 6 caracteres.');
            } else if (error.code === 'permission-denied' || error.message.includes('insufficient permissions')) {
                alert('ERRO DE PERMISSÃO: Verifique suas Regras de Segurança e se você está logado como admin.');
            } else {
                alert('Ocorreu um erro ao criar o usuário.');
            }
        }
    });
</script>
</body>
</html>

